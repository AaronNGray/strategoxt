#! /bin/sh

WORKINGDIR=`pwd`
echo "** INFO -- Working directory: $WORKINGDIR"

# try to set the best BOOTSTRAP_MAKE variable: MAKE <+ gmake <+ make
BESTMAKE=
gmake -v
if [ "$?" != "0" ]
  then
    echo "** INFO -- gmake is not on the PATH. Assuming GNU Make is make!"
    BESTMAKE="make"
  else
    BESTMAKE="gmake"
fi
BOOTSTRAP_MAKE=${MAKE-$BESTMAKE}
echo "** INFO -- Make is: $BOOTSTRAP_MAKE"
# end of setting BOOTSTRAP_MAKE

# touch bootstrapped sources because subversion doesn't sets the mtime of files
# to checkout time, not to the last mtime in the repository.
MTIME=`date +%Y%m%d%H%M.%S`
echo "** INFO -- Modification time: $MTIME"
find . -print | xargs touch -t $MTIME
# end of touch

# install bootstrap time packages: autoxt
mkdir -p pre-pkgs
mkdir -p pre-pkgs/bootstrap
cp -rf autoxt pre-pkgs/bootstrap/
cd pre-pkgs/bootstrap/autoxt
./bootstrap  || exit 1
./configure --prefix=$WORKINGDIR/pre-pkgs/bootstrap  || exit 1
$BOOTSTRAP_MAKE  || exit 1
$BOOTSTRAP_MAKE install || exit 1

cd $WORKINGDIR
PATH=$WORKINGDIR/pre-pkgs/bootstrap/bin:$PATH
export PATH
echo "** INFO -- AutoXT is `which autoxt`"
echo "** INFO -- aclocal is `which aclocal`"
echo "** INFO -- libtoolize is `which libtoolize`"
echo "** INFO -- autoheader is `which autoheader`"
echo "** INFO -- automake is `which automake`"
echo "** INFO -- autoconf is `which autoconf`"

# end of autoxt install

# bootstrap the subpackages
PKGS="autoxt srts xtc strc ssl gpp c-tools concrete-syntax aterm-front stratego-front asfix-tools dot-tools graph-tools sdf-front sdf-tools stratego-regular xml-front xtar stratego-tools boxenv stratego-util stratego-lib strc-core"

for dir in $PKGS
do 
  echo
  echo "** INFO -- bootstrapping in $dir"
  echo
  (cd $dir; ./bootstrap)
done
# end of bootstrap the subpackages

# apply the autotools

rm -f config.cache config.log acconfig.h aclocal.m4

autoxt || exit 1
aclocal -I . || exit 1
libtoolize --force || glibtoolize --force || exit 1
autoconf -f || exit 1
automake -a || exit 1
