.PRECIOUS: %.c %.tree %.ac %.c.abox %.bin \
	   %.s1 %.s2 %.s3 %.s4 %.s5 %.s6 %.s7 %.s8 %.s9 %.s10 %.s11 %.s12 %.s13 

CINCLUDES = \
	--C-include "<srts/stratego.h>" \
	--C-include "<srts/stratego-lib.h>" 

CINCL = -I$(SRTS)/include \
	-I$(ATERM)/include $(CHOICEINCLUDES)

SCLibs = -L$(SRTS)/lib -lstratego-lib -lstratego \
	 -L$(ATERM)/lib -lATerm-gcc $(CHOICELDFLAGS) \
	 -lm

# PRETTY-PRINTING ####################################################

%.txt: % $(STRATEGO_FRONT)/bin/pp-stratego
	$(STRATEGO_FRONT)/bin/pp-stratego -a -i $< -o $@

%.atxt : %
	$(ATERM)/bin/baffle -wt -i $< -o $@

%.ttxt : %
	$(ATERM_TOOLS)/bin/pp-aterm -i $< -o $@

# FRONT-END ###########################################################

%.tree : %.r ../pack/pack-stratego$(EXE) 
	../pack/pack-stratego $(SINCLUDES) -i $< -o $@ 

%.tree : %.str ../pack/pack-stratego$(EXE) 
	../pack/pack-stratego $(SINCLUDES) -i $< -o $@ 

%.tree : %.rtree ../pack/pack-stratego$(EXE) 
	../pack/pack-stratego $(SINCLUDES) -i $< -o $@ 

%.s0 : %.tree ../front/repair-types$(EXE)
	../front/repair-types -i $< -o $@

%.s1 : %.s0 ../front/frontend$(EXE)
	../front/frontend -i $< -o $@ -b --verbose 10

%.s2 : %.s1 ../front/extract$(EXE)
	../front/extract -i $< -o $@ -b

%.s2.check: %.s2
	../sig/Stratego-Normal-Format -i $< -o $@ -b

%.s3 : %.s2 %.s2.check ../front/rename-defs$(EXE)
	../front/rename-defs -i $< -o $@ -b

# OPTIMIZE ###########################################################

## Simplification

%.s4 : %.s3 ../match/optimize1$(EXE)
	../match/optimize1 -i $< -o $@ -b

## Innermost fusion

%.s5: %.s4 ../opt/fusion$(EXE)
	../opt/fusion  -i $< -o $@ -b --verbose 2

# Inlining

%.s6 : %.s5 ../opt/inline$(EXE)
	../opt/inline -i $< -o $@ -b

%.s7 : %.s6 ../opt/dead-def-elim$(EXE)
	../opt/dead-def-elim -i $< -o $@ -b

## First Optimization

%.s7.opt1 : %.s7 ../match/optimize2$(EXE)
	../match/optimize2 -i $< -o $@ -b

%.s7.opt2 : %.s7.opt1 ../match/define-congruences$(EXE)
	../match/define-congruences -i $< -o $@ -b

%.s7.opt3 : %.s7.opt2 ../opt/const-prop$(EXE)
	../opt/const-prop -i $< -o $@ -b

%.s7.opt4 : %.s7.opt3 ../c/canonicalize$(EXE)
	../c/bound-unbound-vars -i $< -o $@ -b

%.s7.opt5 : %.s7.opt4 ../opt/dead-var-elim$(EXE)
	../opt/dead-var-elim -i $< -o $@ -b

%.s7.opt : %.s7.opt5 ../match/optimize2$(EXE)
	../match/optimize2 -i $< -o $@ -b

## Pattern match compilation

%.s8 : %.s7.opt ../match/compile-match$(EXE)
	../match/compile-match -i $< -o $@ -b

%.s9 : %.s8 ../match/desugar-case$(EXE)
	../match/desugar-case -i $< -o $@ -b

# Inlining

%.s10 : %.s9 ../opt/inline$(EXE)
	../opt/inline -i $< -o $@ -b

%.s11 : %.s10 ../opt/dead-def-elim$(EXE)
	../opt/dead-def-elim -i $< -o $@ -b

## Second optimization

%.s11.opt1 : %.s11 ../match/optimize2$(EXE)
	../match/optimize2 -i $< -o $@ -b

%.s11.opt2 : %.s11.opt1 ../opt/const-prop$(EXE)
	../opt/const-prop -i $< -o $@ -b

%.s11.opt3 : %.s11.opt2 ../c/canonicalize$(EXE)
	../c/bound-unbound-vars -i $< -o $@ -b

%.s11.opt4 : %.s11.opt3 ../opt/dead-var-elim$(EXE)
	../opt/dead-var-elim -i $< -o $@ -b

%.s11.opt : %.s11.opt4 ../match/optimize2$(EXE)
	../match/optimize2 -i $< -o $@ -b

# BACK-END ###########################################################

%.s12 : %.s11.opt ../c/canonicalize$(EXE)
	../c/canonicalize -i $< -o $@ -b

%.s13 : %.s12 ../c/canonicalize$(EXE)
	../c/bound-unbound-vars -i $< -o $@ -b

%.s13.check : %.s13 ../sig/Stratego-Canonical-Format$(EXE)
	../sig/Stratego-Canonical-Format -i $< -o $@ -b

%.ac : %.s13 %.s13.check ../c/s2c$(EXE)
	../c/s2c -i $< -o $@  $(CINCLUDES)  -b

%.c.abox : %.ac $(C_TOOLS)/share/c-tools/C-pretty.pp
	time $(GPP)/bin/ast2abox -p $(C_TOOLS)/share/c-tools/C-pretty.pp -i $< -o $@

%.c.abox.check : %.c.abox
	abox-format -i $< 

%.c : %.c.abox 
	time $(GPP)/bin/abox2text -i $< -o $@

# C COMPILATION #####################################################


%.o: %.c
	time $(CC) $(DEFS) $(CINCL) -g -c $< -O4

%.bin : %.o 
	time $(CC) -g $< -o $@ $(SCLibs)

# RUNNING ###########################################################

%.run : %.bin
	./$< 

%.io-run : %.bin
	$< -i $*.in -o $*.out 

# PARSING C PROGRAMS ###############################################

%.af: %.c
	sglr -p $(C_TOOLS)/share/cgen/c.tbl -i $< -o $@ 

%.trm: %.af
	implode-asfix -i $< -o $@

# USING INSTALLED SC ###############################################

%.ibin: %.r
	../sc/strc -O 4 -i $< -o $@ --verbose 3 --output-optimized --output-canonical

%.irun: %.ibin
	./$<

%.trm: %
	$(ATERM)/bin/baffle -wt -i $< -o $@

