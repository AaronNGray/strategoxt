.PRECIOUS: %.c %.tree %.ac %.c.abox %.bin \
	   %.f1 %.f2 %.f3 %.f4 %.f5 %.f6 %.f7 %.f8 %.f9 %.f10 %.f11 %.f12 %.f13 \
	   %.s1 %.s2 %.s3 %.s4 %.s5 %.s6 %.s7 %.s8 %.s9 %.s10 %.s11 %.s12 %.s13 

CINCLUDES = \
	--C-include "<srts/stratego.h>" \
	--C-include "<stratego-lib/stratego-lib.h>" 

CINCL = -I$(SRTS)/include \
	-I$(ATERM)/include $(CHOICEINCLUDES)

AM_CFLAGS = -I$(STRATEGO_LIB)/include -I$(SRTS)/include -I$(ATERM)/include -I /usr/include

SCLibs = -L$(STRATEGO_LIB)/lib/stratego-lib -lstratego-lib-native -L$(SRTS)/lib/srts -lstratego-runtime-choice -lstratego-runtime \
	 -L$(ATERM)/lib -lATerm-gcc $(CHOICELDFLAGS) \
	 -lm

# PRETTY-PRINTING ####################################################

%.txt: % $(STRATEGO_FRONT)/bin/pp-stratego
	$(STRATEGO_FRONT)/bin/pp-stratego -a -i $< -o $@ --verbose 0

%.atxt : %
	$(ATERM)/bin/baffle -wt -i $< -o $@

%.ttxt : %
	$(ATERM_FRONT)/bin/pp-aterm -i $< -o $@ --verbose 0

# FRONT-END ###########################################################

%.tree : %.str #../pack/pack-stratego$(EXEEXT) 
	../pack/pack-stratego $(SINCLUDES) -i $< -o $@ 

#%.tree : %.r #../pack/pack-stratego$(EXEEXT)
#	../pack/pack-stratego $(SINCLUDES) -i $< -o $@ --verbose 0

%.tree : %.rtree # ../pack/pack-stratego$(EXEEXT) 
	../pack/pack-stratego $(SINCLUDES) -i $< -o $@ 

%.f0 : %.tree # ../front/repair-types$(EXEEXT)
	../front/repair-types -i $< -o $@

#%.s1 : %.s0 # ../front/frontend$(EXEEXT)
#	../front/frontend -i $< -o $@ -b --verbose 3

%.f1 : %.f0 # ../front/pre-desugar$(EXEEXT)
	../front/pre-desugar -i $< -o $@ -b 

%.f2 : %.f1 # ../front/normalize-spec$(EXEEXT)
	../front/normalize-spec -i $< -o $@ -b --dr new

%.f4 : %.f2 # ../front/use-def$(EXEEXT)
	../front/use-def -i $< -o $@ -b 

%.f5 : %.f4 # ../front/check-constructors$(EXEEXT)
	../front/check-constructors -i $< -o $@ -b 

%.f6 : %.f5 # ../front/spec-to-sdefs$(EXEEXT)
	../front/spec-to-sdefs -i $< -o $@ -b 

%.f7 : %.f6 # ../lib/rename-vars$(EXEEXT)
	../lib/rename-vars -i $< -o $@ -b 

%.f8 : %.f7 # ../front/desugar$(EXEEXT)
	../front/desugar -i $< -o $@ -b 

%.f9 : %.f8 # ../front/extract$(EXEEXT)
	../front/extract -i $< -o $@ -b

%.f10 : %.f9 # ../front/stratego-warnings$(EXEEXT)
	../front/stratego-warnings -i $< -o $@ -b -W all

%.s2.check: %.f10 # ../sig/Stratego-Normal-Format$(EXEEXT)
	../sig/Stratego-Normal-Format -i $< -o $@ -b

%.s3 : %.f10 %.s2.check # ../front/rename-defs$(EXEEXT)
	../front/rename-defs -i $< -o $@ -b

# OPTIMIZE ###########################################################

## Simplification

%.s4 : %.s3 # ../opt/simplify1$(EXEEXT)
	../opt/simplify1 -i $< -o $@ -b

## Innermost fusion

%.s5: %.s4 # ../opt/fusion$(EXEEXT)
	../opt/fusion  -i $< -o $@ -b --verbose 2

# Inlining

%.s5.opt1 : %.s5 # ../opt/worker-wrapper$(EXEEXT)
	../opt/worker-wrapper -i $< -o $@ -b

%.s6 : %.s5.opt1 # ../opt/inline$(EXEEXT)
	../opt/inline -i $< -o $@ -b

%.s7 : %.s6 # ../opt/dead-def-elim$(EXEEXT)
	../opt/dead-def-elim -i $< -o $@ -b

## First Optimization

%.s7.opt1 : %.s7 # ../opt/simplify1$(EXEEXT)
	../opt/simplify1 -i $< -o $@ -b

%.s7.opt2 : %.s7.opt1 # ../opt/define-congruences$(EXEEXT)
	../opt/define-congruences -i $< -o $@ -b

%.s7.opt3 : %.s7.opt2 # ../opt/const-prop$(EXEEXT)
	../opt/const-prop -i $< -o $@ -b

%.s7.opt4 : %.s7.opt3 # ../opt/bound-unbound-vars$(EXEEXT)
	../opt/bound-unbound-vars -i $< -o $@ -b

%.s7.opt5 : %.s7.opt4 # ../opt/dead-var-elim$(EXEEXT)
	../opt/dead-var-elim -i $< -o $@ -b

%.s7.opt : %.s7.opt5 # ../opt/simplify3$(EXEEXT)
	../opt/simplify3 -i $< -o $@ -b

## Pattern match compilation

%.s8 : %.s7.opt # ../match/compile-match$(EXEEXT)
	../match/compile-match -i $< -o $@ -b

%.s9 : %.s8 # ../match/desugar-case$(EXEEXT)
	../match/desugar-case -i $< -o $@ -b

# Inlining

%.s10 : %.s9 # ../opt/inline$(EXEEXT)
	../opt/inline -i $< -o $@ -b

%.s11 : %.s10 # ../opt/dead-def-elim$(EXEEXT)
	../opt/dead-def-elim -i $< -o $@ -b

## Second optimization

%.s11.opt1 : %.s11 # ../opt/simplify1$(EXEEXT)
	../opt/simplify2 -i $< -o $@ -b

%.s11.opt2 : %.s11.opt1 # ../opt/const-prop$(EXEEXT)
	../opt/const-prop -i $< -o $@ -b

%.s11.opt3 : %.s11.opt2 # ../opt/bound-unbound-vars$(EXEEXT)
	../opt/bound-unbound-vars -i $< -o $@ -b

%.s11.opt4 : %.s11.opt3 # ../opt/dead-var-elim$(EXEEXT)
	../opt/dead-var-elim -i $< -o $@ -b

%.s11.opt : %.s11.opt4 # ../opt/simplify3$(EXEEXT)
	../opt/simplify3 -i $< -o $@ -b

%.s11.check: %.s11.opt # ../sig/Stratego-Optimized-Format$(EXEEXT)
	../sig/Stratego-Optimized-Format -i $< -o $@ -b

# BACK-END ###########################################################

%.s12 : %.s11.opt %.s11.check # ../opt/canonicalize$(EXEEXT)
	../opt/canonicalize -i $< -o $@ -b

%.s12.lift : %.s12 # ../opt/lift-definitions$(EXEEXT)
	../opt/lift-definitions -i $< -o $@ -b

%.s12.opt : %.s12.lift # ../opt/simplify2$(EXEEXT)
	../opt/simplify1 -i $< -o $@ -b

%.s13 : %.s12.opt # ../opt/bound-unbound-vars$(EXEEXT)
	../opt/bound-unbound-vars -i $< -o $@ -b

%.s13.check : %.s13 # ../sig/Stratego-Canonical-Format$(EXEEXT)
	../sig/Stratego-Canonical-Format -i $< -o $@ -b

%.ac : %.s13 %.s13.check # ../c/s2c$(EXEEXT)
	../c/s2c -i $< -o $@  $(CINCLUDES) -b

%.c.abox : %.ac $(C_TOOLS)/share/c-tools/C-pretty.pp
	$(GPP)/bin/ast2abox -p $(C_TOOLS)/share/c-tools/C-pretty.pp -i $< -o $@

%.c.abox.check : %.c.abox
	abox-format -i $< 

%.c : %.c.abox 
	$(GPP)/bin/abox2text -i $< -o $@

# PARSING C PROGRAMS ###############################################

%.af: %.c
	sglr -p $(C_TOOLS)/share/cgen/c.tbl -i $< -o $@ 

%.trm: %.af
	implode-asfix -i $< -o $@

# USING INSTALLED STRC ###############################################

%.ic: %.r
	../strc/strc $(SINCLUDES) $(SCFLAGS) -i $< -c -o $@ --verbose 3
	cp $*.c $@

%.io: %.ic
	$(CC) $(DEFS) $(CINCL) -g -c $*.c -O4
	cp $*.o $@

%.ibin : %.io $($*OBJECTS)
	-$(MAKE) $< $($*OBJECTS)
	$(LINK) $*.o $($*OBJECTS) $(SCLibs)

#$(CC) -o $@ -g $*.o $($*OBJECTS) $(SCLibs)

%.ilib: %.r
	../strc/strc $(SINCLUDES) $(SCFLAGS) -i $< -o $@ --verbose 3 --library

lib%.c : %.r
	../strc/strc $(SINCLUDES) $(SCFLAGS) -i $< -c -o $@ --verbose 3 --library

%.irun: %.ibin
	./$<

%.trm: %
	$(ATERM)/bin/baffle -wt -i $< -o $@
