module dr-scope-tests
imports
  dr-test-utils

/**
 * This test suite uses tests setting rules, adding rules and
 * looking up rules by using low level calls to the dynamic
 * rules library. The low level calls are wrapped with some
 * nice strategies with fewer arguments defined in dr-test-utils.str
 * to allow for better readability of the tests.
 */

strategies

  scope-tests =
    test-suite(!"Dynamic Rules Library -- Scoping",
      where(separation-message(|"Dynamic Rules Library -- Scoping -- Setting Rules Tests"))
    ; where(description-message(|"  notation in test names:"))
    ; where(description-message(|"    - RS means Rule Scope"))
    ; where(description-message(|"    - CS means Change Set"))
    ; scope-set-tests
    ; where(separation-message(|"Dynamic Rules Library -- Scoping -- Adding Rules Tests"))
    ; scope-add-tests
    ; where(separation-message(|"Dynamic Rules Library -- Scoping -- Looking Up Rules Tests"))
    ; scope-lookup-tests
    )

strategies

  scope-set-tests = id

  ; apply-scope-test(!"Check setting rule (RS CS CS)",
      init-rule-set
      ; rule-scope(|"x", 1)
      ; change-set(|"x", 2)
      ; change-set(|"x", 1)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check setting rule with label (RS CS CS)",
      init-rule-set
      ; rule-scope(|"a", "x", 1)
      ; change-set(|"a", "x", 2)
      ; change-set(|"a", "x", 1)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check setting rule with different values (RS CS RS CS CS) #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 2)
      ; change-set(|"b", "x", 3)
      ; change-set(|"a", "x", 4)
      ; lookup-rule(|"x")
      | [3]
    )

  ; apply-scope-test(!"Check setting rule with different values (RS CS RS CS CS) #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 2)
      ; change-set(|"b", "x", 3)
      ; change-set(|"a", "x", 4)
      ; lookup-all-rules(|"x")
      | [3, 4]
    )

  ; apply-scope-test(!"Check setting rule with similar values (RS CS RS CS CS) #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 0)
      ; change-set(|"b", "x", 1)
      ; change-set(|"a", "x", 0)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check setting rule with similar values (RS CS RS CS CS) #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 0)
      ; change-set(|"b", "x", 1)
      ; change-set(|"a", "x", 0)
      ; lookup-all-rules(|"x")
      | [1, 0]
    )

  ; apply-scope-test(!"Check setting rule vis with different values (RS CS RS CS CS) #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 2)
      ; change-set(|"b", "x", 3)
      ; change-set-vis(|"a", "x", 4)
      ; lookup-rule(|"x")
      | [4]
    )

  ; apply-scope-test(!"Check setting rule vis with different values (RS CS RS CS CS) #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 2)
      ; change-set(|"b", "x", 3)
      ; change-set-vis(|"a", "x", 4)
      ; lookup-all-rules(|"x")
      | [4]
    )

  ; apply-scope-test(!"Check setting rule vis with similar values (RS CS RS CS CS) #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 0)
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 0)
      ; lookup-rule(|"x")
      | [0]
    )

  ; apply-scope-test(!"Check setting rule vis with similar values (RS CS RS CS CS) #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 0)
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 0)
      ; lookup-all-rules(|"x")
      | [0]
    )

    // mark 1
  ; apply-scope-test(!"Check setting rule in different scopes with the same value (RS RS CS CS) #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 2)
      ; change-set(|"a", "x", 2)
      ; lookup-rule(|"x")
      | [2]
    )

  ; apply-scope-test(!"Check setting rule in different scopes with the same value (RS RS CS CS) #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 2)
      ; change-set(|"a", "x", 2)
      ; lookup-all-rules(|"x")
      | [2, 2]
    )

  ; apply-scope-test(!"Check setting rule in different scopes with the same value (RS RS CS CS) #3",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 1)
      ; change-set(|"a", "x", 1)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check setting rule in different scopes with the same value (RS RS CS CS) #4",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 1)
      ; change-set(|"a", "x", 1)
      ; lookup-all-rules(|"x")
      | [1, 1]
    )

  ; apply-scope-test(!"Check setting rule in different scopes with the same value (RS RS CS CS) #5",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"a", "x", 1)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check setting rule in different scopes with the same value (RS RS CS CS) #6",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"a", "x", 1)
      ; lookup-all-rules(|"x")
      | [1, 1]
    )

  ; apply-scope-test(!"Check setting rule vis in different scopes with the same value (RS RS CS CS) #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 2)
      ; change-set-vis(|"a", "x", 2)
      ; lookup-rule(|"x")
      | [2]
    )

  ; apply-scope-test(!"Check setting rule vis in different scopes with the same value (RS RS CS CS) #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 2)
      ; change-set-vis(|"a", "x", 2)
      ; lookup-all-rules(|"x")
      | [2]
    )

  ; apply-scope-test(!"Check setting rule vis in different scopes with the same value (RS RS CS CS) #3",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 1)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check setting rule vis in different scopes with the same value (RS RS CS CS) #4",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 1)
      ; lookup-all-rules(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check setting rule vis in different scopes with the same value (RS RS CS CS) #5",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 1)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check setting rule vis in different scopes with the same value (RS RS CS CS) #6",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 1)
      ; lookup-all-rules(|"x")
      | [1]
    )

    // mark 2
  ; apply-scope-test(!"Check setting rule vis when the definition to be removed is only in change set #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b")
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 2)
      ; lookup-rule(|"x")
      | [2]
    )

  ; apply-scope-test(!"Check setting rule vis when the definition to be removed is only in change set #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b")
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 2)
      ; lookup-all-rules(|"x")
      | [2]
    )

strategies

  scope-add-tests = id

  ; apply-scope-test(!"Check adding rules (RS)",
      init-rule-set
      ; rule-scope(|"x", 1)
      ; add(|"x", 2)
      ; add(|"x", 3)
      ; lookup-rule(|"x")
      | [3, 2, 1]
    )

  ; apply-scope-test(!"Check adding rules (RS CS CS)",
      init-rule-set
      ; rule-scope(|"x", 1)
      ; change-set
      ; add(|"x", 2)
      ; change-set
      ; add(|"x", 3)
      ; lookup-rule(|"x")
      | [3, 2, 1]
    )
/*
  ; apply-scope-test(!"Check adding rules (RS CS CS)",
      init-rule-set
      ; rule-scope(|"x", 1)
      ; change-set(|"x", 2)
      ; change-set(|"x", 1)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check adding rules with label (RS CS CS)",
      init-rule-set
      ; rule-scope(|"a", "x", 1)
      ; change-set(|"a", "x", 2)
      ; change-set(|"a", "x", 1)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check adding rules with different values (RS CS RS CS CS) #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 2)
      ; change-set(|"b", "x", 3)
      ; change-set(|"a", "x", 4)
      ; lookup-rule(|"x")
      | [3]
    )

  ; apply-scope-test(!"Check adding rules with different values (RS CS RS CS CS) #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 2)
      ; change-set(|"b", "x", 3)
      ; change-set(|"a", "x", 4)
      ; lookup-all-rules(|"x")
      | [3, 4]
    )

  ; apply-scope-test(!"Check adding rules with similar values (RS CS RS CS CS) #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 0)
      ; change-set(|"b", "x", 1)
      ; change-set(|"a", "x", 0)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check adding rules with similar values (RS CS RS CS CS) #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 0)
      ; change-set(|"b", "x", 1)
      ; change-set(|"a", "x", 0)
      ; lookup-all-rules(|"x")
      | [1, 0]
    )

  ; apply-scope-test(!"Check adding rules vis with different values (RS CS RS CS CS) #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 2)
      ; change-set(|"b", "x", 3)
      ; change-set-vis(|"a", "x", 4)
      ; lookup-rule(|"x")
      | [4]
    )

  ; apply-scope-test(!"Check adding rules vis with different values (RS CS RS CS CS) #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 2)
      ; change-set(|"b", "x", 3)
      ; change-set-vis(|"a", "x", 4)
      ; lookup-all-rules(|"x")
      | [4]
    )

  ; apply-scope-test(!"Check adding rules vis with similar values (RS CS RS CS CS) #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 0)
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 0)
      ; lookup-rule(|"x")
      | [0]
    )

  ; apply-scope-test(!"Check adding rules vis with similar values (RS CS RS CS CS) #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"a", "x", 1)
      ; rule-scope(|"b", "x", 0)
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 0)
      ; lookup-all-rules(|"x")
      | [0]
    )

  ; apply-scope-test(!"Check adding rules in different scopes with the same value (RS RS CS CS) #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 2)
      ; change-set(|"a", "x", 2)
      ; lookup-rule(|"x")
      | [2]
    )

  ; apply-scope-test(!"Check adding rules in different scopes with the same value (RS RS CS CS) #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 2)
      ; change-set(|"a", "x", 2)
      ; lookup-all-rules(|"x")
      | [2, 2]
    )

  ; apply-scope-test(!"Check adding rules in different scopes with the same value (RS RS CS CS) #3",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 1)
      ; change-set(|"a", "x", 1)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check adding rules in different scopes with the same value (RS RS CS CS) #4",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 1)
      ; change-set(|"a", "x", 1)
      ; lookup-all-rules(|"x")
      | [1, 1]
    )

  ; apply-scope-test(!"Check adding rules in different scopes with the same value (RS RS CS CS) #5",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"a", "x", 1)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check adding rules in different scopes with the same value (RS RS CS CS) #6",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"a", "x", 1)
      ; lookup-all-rules(|"x")
      | [1, 1]
    )

  ; apply-scope-test(!"Check adding rules vis in different scopes with the same value (RS RS CS CS) #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 2)
      ; change-set-vis(|"a", "x", 2)
      ; lookup-rule(|"x")
      | [2]
    )

  ; apply-scope-test(!"Check adding rules vis in different scopes with the same value (RS RS CS CS) #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 2)
      ; change-set-vis(|"a", "x", 2)
      ; lookup-all-rules(|"x")
      | [2]
    )

  ; apply-scope-test(!"Check adding rules vis in different scopes with the same value (RS RS CS CS) #3",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 1)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check adding rules vis in different scopes with the same value (RS RS CS CS) #4",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 1)
      ; lookup-all-rules(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check adding rules vis in different scopes with the same value (RS RS CS CS) #5",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 1)
      ; lookup-rule(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check adding rules vis in different scopes with the same value (RS RS CS CS) #6",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 1)
      ; lookup-all-rules(|"x")
      | [1]
    )

  ; apply-scope-test(!"Check adding rules vis when the definition to be removed is only in change set #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b")
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 2)
      ; lookup-rule(|"x")
      | [2]
    )

  ; apply-scope-test(!"Check adding rules vis when the definition to be removed is only in change set #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b")
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 2)
      ; lookup-all-rules(|"x")
      | [2]
    )
*/
strategies

  scope-lookup-tests = id

  ; apply-scope-test(!"Check looking up rule in scope #1",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b")
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 2)
      ; lookup-rule-in-scope(|"a", "x")
      | [2]
    )

  ; apply-and-fail(!"Check looking up rule in scope #2",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b")
      ; change-set(|"b", "x", 1)
      ; change-set-vis(|"a", "x", 2)
      ; lookup-rule-in-scope(|"b", "x")
      , !()
    )

  ; apply-scope-test(!"Check looking up rule in scope #3",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b")
      ; change-set(|"b", "x", 1)
      ; change-set(|"a", "x", 2)
      ; lookup-rule-in-scope(|"a", "x")
      | [2]
    )

  ; apply-scope-test(!"Check looking up rule in scope #4",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b")
      ; change-set(|"b", "x", 1)
      ; change-set(|"a", "x", 2)
      ; lookup-rule-in-scope(|"b", "x")
      | [1]
    )

  ; apply-scope-test(!"Check looking up rule in scope #5",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"a", "x", 2)
      ; lookup-rule-in-scope(|"a", "x")
      | [2]
    )

  ; apply-scope-test(!"Check looking up rule in scope #6",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; rule-scope(|"b", "x", 1)
      ; change-set(|"a", "x", 2)
      ; lookup-rule-in-scope(|"b", "x")
      | [1]
    )

  ; apply-scope-test(!"Check looking up rule in scope #7",
      init-rule-set
      ; rule-scope(|"a", "x", 0)
      ; change-set(|"x", 1)
      ; rule-scope(|"b", "x", 2)
      ; change-set(|"a", "x", 3)
      ; change-set(|"b", "x", 4)
      ; rule-scope(|"c", "x", 5)
      ; ![ <lookup-rule-in-scope(|"a", "x")>
         , <lookup-rule-in-scope(|"b", "x")>
         , <lookup-rule-in-scope(|"c", "x")>
         ]
      | [[3], [4], [5]]
    )
