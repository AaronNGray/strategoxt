module dr-dce-tests
imports
  dr-test-utils

/**
 * This test suite uses dead code elimination for TIL programs
 * as a real-life test of the dynamic rules library.
 */

strategies

  dead-code-elimination-tests =
    test-suite(!"Dynamic Rules Library -- Dead Code Elimination",
      where(separation-message(|"Dynamic Rules Library -- Dead Code Elimination -- Union Tests"))
//    ; where(description-message(|"  notation in test names: rule before applying intersection"))
//    ; where(description-message(|"                          < rule in left branch"))
//    ; where(description-message(|"                          + rule in right branch"))
//    ; where(description-message(|"  (x,val) means rule with key x, and val decodes like this:"))
//    ; where(description-message(|"    - same letter means redefinition with the same value"))
//    ; where(description-message(|"    - different letter means redefinition with a different value"))
//    ; where(description-message(|"    - \"undef\" means undefinition of rule"))
//    ; where(description-message(|"    - \"none\" means no change to rule"))
//    ; where(description-message(|"    - \"empty\" means no rule is defined at that point"))
    ; dce-union-tests
    ; where(separation-message(|"Dynamic Rules Library -- Dead Code Elimination -- Fix and Union Tests"))
//    ; where(description-message(|"  notation in test names: rule before applying intersection"))
//    ; where(description-message(|"                          ; [rule in iteration]*"))
//    ; where(description-message(|"  (x,val) decodes as before"))
    ; dce-fix-and-union-tests
/*
    ; where(separation-message(|"Dynamic Rules Library -- Dead Code Elimination -- Break Tests"))
    ; pc-break-tests
    ; where(separation-message(|"Dynamic Rules Library -- Dead Code Elimination -- Break to Label Tests"))
    ; pc-break-to-label-tests
    ; where(separation-message(|"Dynamic Rules Library -- Dead Code Elimination -- Continue Tests"))
    ; pc-continue-tests
    ; where(separation-message(|"Dynamic Rules Library -- Dead Code Elimination -- Continue to Label Tests"))
    ; pc-continue-to-label-tests
    ; where(separation-message(|"Dynamic Rules Library -- Dead Code Elimination -- Exception Tests"))
    ; pc-exception-tests
*/
    )

strategies

  dce-union-tests = id

  ; apply-dce-test(!"Check rule set for VarNeeded after x < x + x" |
      "var x; x := 0; if c() then f(x); else f(x); end f(x);",
      "var x; x := 0; if c() then f(x); else f(x); end f(x);"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after x < x + none" |
      "var x; x := 0; if c() then f(x); else dummy(); end f(x);",
      "var x; x := 0; if c() then f(x); else dummy(); end f(x);"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after x < none + x" |
      "var x; x := 0; if c() then dummy(); else f(x); end f(x);",
      "var x; x := 0; if c() then dummy(); else f(x); end f(x);"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after x < none + none" |
      "var x; x := 0; if c() then dummy(); else dummy(); end f(x);",
      "var x; x := 0; if c() then dummy(); else dummy(); end f(x);"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after x < x + undef" |
      "var x; x := 0; if c() then f(x); else x := 0; end f(x);",
      "var x; x := 0; if c() then f(x); else x := 0; end f(x);"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after x < undef + x" |
      "var x; x := 0; if c() then x := 0; else f(x); end f(x);",
      "var x; x := 0; if c() then x := 0; else f(x); end f(x);"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after x < undef + undef" |
      "var x; x := 0; if c() then x := 0; else x := 0; end f(x);",
      "var x; if c() then x := 0; else x := 0; end f(x);"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after x < none + undef" |
      "var x; x := 0; if c() then dummy(); else x := 0; end f(x);",
      "var x; x := 0; if c() then dummy(); else x := 0; end f(x);"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after x < undef + none" |
      "var x; x := 0; if c() then x := 0; else dummy(); end f(x);",
      "var x; x := 0; if c() then x := 0; else dummy(); end f(x);"
    )

///

  ; apply-dce-test(!"Check rule set for VarNeeded after empty < x + x" |
      "var x; x := 0; if c() then f(x); else f(x); end",
      "var x; x := 0; if c() then f(x); else f(x); end"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after empty < x + none" |
      "var x; x := 0; if c() then f(x); else dummy(); end",
      "var x; x := 0; if c() then f(x); else dummy(); end"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after empty < none + x" |
      "var x; x := 0; if c() then dummy(); else f(x); end",
      "var x; x := 0; if c() then dummy(); else f(x); end"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after empty < none + none" |
      "var x; x := 0; if c() then dummy(); else dummy(); end",
      "if c() then dummy(); else dummy(); end"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after empty < x + undef" |
      "var x; x := 0; if c() then f(x); else dummy(); x := 0; end",
      "var x; x := 0; if c() then f(x); else dummy(); end"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after empty < undef + x" |
      "var x; x := 0; if c() then dummy(); x := 0; else f(x); end",
      "var x; x := 0; if c() then dummy(); else f(x); end"
    )

  ; apply-dce-test(!"Check rule set for VarNeeded after empty < undef + undef" |
      "var x; x := 0; if c() then x := 0; else x := 0; end dummy();",
      "dummy();"
    )

  ; fail-dce-test(!"Check rule set for VarNeeded after empty < none + undef" |
      "var x; x := 0; if c() then dummy(); else x := 0; end dummy();",
      "dummy();"
    )

  ; fail-dce-test(!"Check rule set for VarNeeded after empty < undef + none" |
      "var x; x := 0; if c() then x := 0; else dummy(); end dummy();",
      "dummy();"
    )

  dce-fix-and-union-tests = id
