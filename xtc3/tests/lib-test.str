/**
 * XTC composition library testsuite
 *  
 * @author Niels Janssen (njanssen@cs.uu.nl)
 */
module lib-test
imports lib-test-overlays
imports lib xtc-lib

strategies

  main-lib-test =
    xtc-wrap(
      repository-option + verbose-option
    , <set-config> ("program","lib-test")
    ; named-test-suite(xtc-repository-tests |"[xtc-repository tests]")
    ; named-test-suite(xtc-register-tests   |"[xtc-register tests]")
    ; named-test-suite(xtc-search-tests     |"[xtc-search tests]")
    ; named-test-suite(xtc-find-tests       |"[xtc-find tests]")
    ; named-test-suite(xtc-model-tests      |"[xtc-model tests]")
    ; named-test-suite(xtc-adapt-tests      |"[xtc-adapt tests]")
    )

strategies

  xtc-adapt-tests = 
    /* transform args to exec model */
    apply-test( 
      !"xtc-args-to-exec"
    , xtc-args-to-exec
    , !arg |[ ("-i",FILE : "i.trm"), "-b", ("--verbose", "10") ]|*
    , !["-i","i.trm","-b","--verbose","10"]
    )
  ; apply-test( 
      !"xtc-args-to-exec"
    , xtc-args-to-exec
    , !arg |[ "--foo", ("--url", URL : "http://bar.com") ]|*
    , !["--foo","--url","http://bar.com"]
    )
    /* transform args to http model */
  ; apply-test( 
      !"xtc-args-to-http"
    , xtc-args-to-http
    , !arg |[ ("-i",FILE : "i.trm"), "-b", ("--verbose", "10") ]|*
    , ![("-F","-i=@i.trm"),("-F","-b"),("-F","--verbose=10")]
    )
  ; apply-test( 
      !"xtc-args-to-http"
    , xtc-args-to-http
    , !arg |[ "--foo", ("--url", URL : "http://bar.com") ]|*
    , ![("-F","--foo"),("-F","--url=@http://bar.com")]
    )
  ; apply-test( 
      !"xtc-args-to-xtservice"
    , xtc-args-to-xtservice
    , !arg |[ FILE : "some.trm", "--foo" ]|*
    , ![("-F","ARGUMENTS=@some.trm"),("-F","ARGUMENTS=--foo")]
    )

  /** 
   * Testsuite for xtc-model 
   */
  xtc-model-tests = 
    /* Template desugaring */
    apply-test( 
      !"xtc-desugar-template"
    , xtc-desugar-template
    , !|[ explicit template {} ]|
    , !|[ explicit template { layout = } ]|
    )
  ; apply-test( 
      !"xtc-desugar-template"
    , xtc-desugar-template
    , !|[ regular template {} ]|
    , !|[ regular template { layout = } ]|
    )
  ; apply-test( 
      !"xtc-desugar-template"
    , xtc-desugar-template
    , !|[ implicit template {} ]|
    , !|[ implicit template { layout = } ]|
    )
    /* Descriptor desugaring */
  ; apply-test( 
      !"xtc-desugar-desc" 
    , xtc-desugar-desc 
    , !|[ descriptor = xt ]| 
    , !|[ descriptor = exec 
            streams { 
              input  = file "-i"
              output = file "-o"
            }
       ]| 
    )
  ; apply-and-fail( 
      !"xtc-desugar-desc" 
    , xtc-desugar-desc 
    , !|[ descriptor = exec 
            streams { 
              input  = file "-i"
              output = file "-o"
            }
       ]| 
    )
  ; apply-and-fail( 
      !"xtc-desugar-desc" 
    , xtc-desugar-desc
    , !|[ descriptor = xtservice ]| 
    )
    /* Model desugaring */
  ; apply-test(
      !"xtc-desugar-model"
    , xtc-desugar-model
    , !model-exec-implicit
    , !model-exec-regular
    ) 
  ; apply-test(
      !"xtc-desugar-model"
    , xtc-desugar-model
    , !model-xt-implicit
    , !model-exec-regular
    ) 
  ; apply-test(
      !"xtc-desugar-model"
    , xtc-desugar-model
    , !model-exec-regular
    , !model-exec-regular
    ) 
  /* Argument desugaring */
  ; apply-test( 
      !"xtc-desugar-arg"
    , xtc-desugar-arg
    , !"-a"
    , !arg |[ "-a" ]|*
    )
  ; apply-test( 
      !"xtc-desugar-arg"
    , xtc-desugar-arg
    , !("-a","foo")
    , !arg |[ ("-a","foo") ]|*
    )
  ; apply-test( 
      !"xtc-desugar-arg"
    , xtc-desugar-arg
    , !("-a",FILE("foo"))
    , !arg |[ ("-a",FILE : "foo") ]|*
    )
  ; apply-test( 
      !"xtc-desugar-arg"
    , xtc-desugar-arg
    , !("-a",URL("foo"))
    , !arg |[ ("-a",URL : "foo") ]|*
    )
  ; apply-test( 
      !"xtc-desugar-arg"
    , xtc-desugar-arg
    , !("-a",["foo","bar","fred"])
    , !arg |[ ("-a","foo"), ("-a","bar"), ("-a","fred") ]|*
    )
  ; apply-test(
      !"xtc-desugar-args"
    , xtc-desugar-args
    , !["-a","-b",("-c",["foo","bar"]),("--bar",FILE("bar")), ("--fred",URL("fred"))]
    , !arg |[ "-a", "-b", ("-c","foo"), ("-c", "bar")
            , ("--bar", FILE : "bar"), ("--fred", URL : "fred") ]|*
    ) 
  /* Model related argument generation */
  ; apply-test( 
      !"xtc-model-to-args"
    , xtc-model-to-args(|configuration-empty)
    , !model-xt-implicit ; xtc-desugar-model
    , <XtcConf(id,id,id,![])> configuration-empty
    )
  ; apply-test( 
      !"xtc-model-to-args"
    , xtc-model-to-args(|configuration-io)
    , !model-xt-implicit ; xtc-desugar-model
    , <XtcConf(id,id,id,!arg |[ ("-i",FILE : "i"), ("-o",FILE : "o") ]|*)> configuration-io
    )
  ; apply-test( 
      !"xtc-model-to-args"
    , xtc-model-to-args(|configuration-io)
    , !model-xtservice-implicit ; xtc-desugar-model
    , <XtcConf(id,id,id,!arg |[ ("-i",FILE : "i") ]|*)> configuration-io
    )

  /** Optional '?' **/ // Option
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-b", "-c" ]|*)
    , !|[ option? "-b" ]|
    , !arg |[ "-b" ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "--bar", "-c" ]|*)
    , !|[ option? "--bar" | "-b" ]|
    , !arg |[ "--bar" ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-b", "-c" ]|*)
    , !|[ option? "--bar" | "-b" ]|
    , !arg |[ "-b" ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-c" ]|*)
    , !|[ option? "-b" ]|
    , !arg |[  ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-c" ]|*)
    , !|[ option? "-b" { on }]|
    , !arg |[ "-b" ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-c" ]|*)
    , !|[ option? "-b" { off }]|
    , !arg |[ ]|*      
    )

  /** Optional '?' **/ // ArgOption
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-c" ]|*)
    , !|[ argoption? "-b" ]|
    , !arg |[ ("-b","foo") ]|*  
    )
  ; apply-test(
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-c" ]|*)
    , !|[ argoption? "-b" ]|
    , !arg |[ ]|*
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-b", "-c" ]|*)
    , !|[ argoption? "-b" ]|
    , !arg |[ ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a" ]|*)
    , !|[ argoption? "-b" | "--bar" { "foo", "bar" } ]|
    , !arg |[ ("-b","foo") ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a" ]|*)
    , !|[ argoption? "-b" | "--bar" { } ]|
    , !arg |[ ]|*  
    )

  /** One ' ' **/ // Option
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-b", "-c" ]|*)
    , !|[ option "-b" ]|
    , !arg |[ "-b" ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "--bar", "-c" ]|*)
    , !|[ option "--bar" | "-b" ]|
    , !arg |[ "--bar" ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-b", "-c" ]|*)
    , !|[ option "--bar" | "-b" ]|
    , !arg |[ "-b" ]|*  
    )
  ; apply-and-fail( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-c" ]|*)
    , !|[ option "-b" ]|
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-c" ]|*)
    , !|[ option "-b" { on }]|
    , !arg |[ "-b" ]|*  
    )
  ; apply-and-fail( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-c" ]|*)
    , !|[ option "-b" { off }]|
    )

  /** One ' ' **/ // ArgOption
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-c" ]|*)
    , !|[ argoption "-b" ]|
    , !arg |[ ("-b","foo") ]|*  
    )
  ; apply-and-fail(
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-c" ]|*)
    , !|[ argoption "-b" ]|
    )
  ; apply-and-fail( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-b", "-c" ]|*)
    , !|[ argoption "-b" ]|
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a" ]|*)
    , !|[ argoption "-b" | "--bar" { "foo", "bar" } ]|
    , !arg |[ ("-b","foo") ]|*  
    )
  ; apply-and-fail( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a" ]|*)
    , !|[ argoption "-b" | "--bar" { } ]|
    )

  /** One or More (Plus) '+' **/ // Option
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-b", "-c" ]|*)
    , !|[ option+ "-b" ]|
    , !arg |[ "-b" ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "--bar", "-c" ]|*)
    , !|[ option+ "--bar" | "-b" ]|
    , !arg |[ "--bar" ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-b", "-c" ]|*)
    , !|[ option+ "--bar" | "-b" ]|
    , !arg |[ "-b" ]|*  
    )
  ; apply-and-fail( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-c" ]|*)
    , !|[ option+ "-b" ]|
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-c" ]|*)
    , !|[ option+ "-b" { on }]|
    , !arg |[ "-b" ]|*  
    )
  ; apply-and-fail( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-c" ]|*)
    , !|[ option+ "-b" { off }]|
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-b", "-b", "-c" ]|*)
    , !|[ option+ "-b" { on }]|
    , !arg |[ "-b", "-b" ]|*  
    ) 

  /** One or More (Plus) '+' **/ // ArgOption
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-c" ]|*)
    , !|[ argoption+ "-b" ]|
    , !arg |[ ("-b","foo") ]|*  
    )
  ; apply-and-fail(
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-c" ]|*)
    , !|[ argoption+ "-b" ]|
    )
  ; apply-and-fail( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-b", "-c" ]|*)
    , !|[ argoption+ "-b" ]|
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a" ]|*)
    , !|[ argoption+ "-b" | "--bar" { "foo", "bar" } ]|
    , !arg |[ ("-b","foo"), ("-b","bar") ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), ("-b","bar") ]|*)
    , !|[ argoption+ "-b" | "--bar" { } ]|
    , !arg |[ ("-b","foo"), ("-b","bar") ]|*
    )
   
  /** Zero or More (Star) '*' **/ // Option
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-b", "-c" ]|*)
    , !|[ option* "-b" ]|
    , !arg |[ "-b" ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "--bar", "-c" ]|*)
    , !|[ option* "--bar" | "-b" ]|
    , !arg |[ "--bar" ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-b", "-c" ]|*)
    , !|[ option* "--bar" | "-b" ]|
    , !arg |[ "-b" ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-c" ]|*)
    , !|[ option* "-b" ]|
    , !arg |[ ]|*
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-c" ]|*)
    , !|[ option* "-b" { on }]|
    , !arg |[ "-b" ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-c" ]|*)
    , !|[ option* "-b" { off }]|
    , !arg |[ ]|*
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-b", "-b", "-c" ]|*)
    , !|[ option* "-b" { on }]|
    , !arg |[ "-b", "-b" ]|*  
    ) 

  /** Zero or More (Star) '*' **/ // ArgOption
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), "-c" ]|*)
    , !|[ argoption* "-b" ]|
    , !arg |[ ("-b","foo") ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-c" ]|*)
    , !|[ argoption* "-b" ]|
    , !arg |[ ]|*
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", "-b", "-c" ]|*)
    , !|[ argoption* "-b" ]|
    , !arg |[ ]|*
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a" ]|*)
    , !|[ argoption* "-b" | "--bar" { "foo", "bar" } ]|
    , !arg |[ ("-b","foo"), ("-b","bar") ]|*  
    )
  ; apply-test( 
      !"xtc-targ-to-args"
    , xtc-targ-to-args(| arg |[ "-a", ("-b","foo"), ("-b","bar") ]|*)
    , !|[ argoption* "-b" | "--bar" { } ]|
    , !arg |[ ("-b","foo"), ("-b","bar") ]|*
    )

  /** 
   * Wrapper for xtc-targ-to-args rules which are actually 
   * used in a thread-map
   */   
  xtc-targ-to-args(|args) = 
    !(<xtc-desugar-targ>,args) 
  ; xtc-targ-to-args
  ; Fst

strategies

  xtc-repository-tests =
    apply-and-check(
      !"xtc-location"
    , xtc-location
    , !()
    , is-string
    )
  ; apply-test(
      !"xtc-load"
    , xtc-location
    ; xtc-load
    , !()
    )

  xtc-register-tests = 
    apply-test(
      !"xtc-register-reference"
    , xtc-register-reference 
    , !"XTC.lib-test"
    )
  ; apply-test(
      !"xtc-register-resource"
    , xtc-register-resource
    , !("my resource","/tmp/non-existing/url")
    )
  ; apply-test(
      !"xtc-register-component"
    , xtc-register-component
    , !("my component","/tmp/non-existing/url")
    )
  ; apply-test(
      !"xtc-register-component"
    , xtc-register-component
    , !("my component","/tmp/non-existing/url2")
    )
  ; apply-test(
      !"xtc-import"
    , xtc-import
    , !()
    )
  ; apply-test(
      !"xtc-import"
    , xtc-import
    , !()
    )
  ; apply-test(
      !"xtc-save"
    , xtc-save(|"XTC.save")
    , !()    
    )
  ; apply-test(
      !"xtc-dump"
    , xtc-dump(|"XTC.dump")
    , !()
    )

strategies

  xtc-search-tests =
    apply-test(
      !"xtc-search"
    , xtc-search
    , !|[ $strc ]|
    , (|[ $strc ]|,(is-string,is-list))
    )
  ; apply-test(
      !"xtc-search"
    , xtc-search
    , !|[ $mysglr ]|
    , !mysglr
    )
  ; apply-test(
      !"xtc-has-meta"
    , xtc-search
    ; xtc-has-meta(|XtcImported)
    , !|[ $mysglr ]|
    , !mysglr
    )
  ; apply-test(
      !"xtc-search"
    , xtc-search => (n,_)
    , !XtcQuery([XtcImported])
    )
  ; apply-test( 
      !"xtc-search"
    , xtc-search 
    , !|[ $mysglr[<model-xt-implicit> <XtcImported>] ]|
    )
  ; apply-test(
      !"xtc-has-meta"
    , xtc-search
    ; xtc-has-meta(|[XtcImported,model-xt-implicit])
    , !|[ $mysglr ]|
    , !mysglr
    )
  ; apply-and-fail(
      !"xtc-has-meta"
    , xtc-search
    ; xtc-has-meta(|XtcLoaded)
    , !|[ $mysglr ]|
    )
  ; apply-and-fail(
      !"xtc-has-meta"
    , xtc-search
    ; xtc-has-meta(|[XtcImported,XtcLoaded])
    , !|[ $mysglr ]|
    )

  xtc-find-tests = 
    apply-test( 
      !"xtc-find-reg"
    , xtc-find-reg
    , !"sglr"
    )
  ; apply-test( 
      !"xtc-find"
    , xtc-find
    , !"sglr"
    )
  ; apply-test( 
      !"xtc-find-path"
    , xtc-find-path
    , !"mysglr"
    , !"/usr/bin"
    )
  ; apply-test( 
      !"xtc-find-reg"
    , xtc-find-reg(one(?x) ; !x)
    , !|[ $strc ]|
    , <xtc-find-reg> "strc"
    )

strategies

  repository-option = 
    ArgOption(
      "-r" + "--repository"
    , where(xtc-init(|<id>))
    , !"--repository rep | -r rep    Tool repository"
    )
    
  named-test-suite(s|name) = 
    say(!"")
  ; test-suite(!name,s)
 
