module sdf-imports
imports get-modules AsFix lib pack-graph pack file Sdf2-Syntax sglr

signature
  sorts Node
  constructors
    Node: X * X * X -> Z

strategies

  main = get-modules(imports-sdf, !"sdf"); <exit>0

  imports-sdf(mkpt, ext) =
	\ root -> (root, ["." | <mkpt>()], []) \;
	graph-nodes(parse-sdf(ext),
		    out-edges,
                    add-node )


parse-sdf( ext) =
        (guarantee-extension(ext), id);
        ?module-name;
        find-in-path => m;
        debug(!"  including ");
        split(id , parse-sdf ) => tree;
        <get-sdf-imports> tree => i;
        <get-module-name> tree => n;
        !Node(module-name, m, i)

rules

add-node: (m, Node( (f,p), location, edges), xs) -> <conc>(xs',[Node(m, location)])
   where
      <map( add_edge(!m) ) >edges => edges';
      <conc>(edges', xs) => xs'

out-edges:
   x -> edges
   where
      ?Node( _,_, edges )

get-sdf-imports:
   x -> y
   where 
      <collect(?appl(prod(_, cf(sort("Import")), _), _); get-module-name, skip)>x => y

get-module-name:
   x -> y
   where
      <oncetd(?appl(prod(_,cf(sort("ModuleId")),_),_);yield=>y)>x

add_edge(k) : x -> e
   where
      k             => k';
      !Edge(k', x ) => e

strategies
   yield = rec x(appl(id, map(x)); \ appl(p, ts) -> <concat> ts \
	        <+ \ a -> [a] \ ); 
           implode-string 

  skip(x,y) =  parsetree(x,id) 
             <+
               appl(prod(id, cf(sort("Module")), id), [id,id,id,x,id,x])
             <+
               appl(prod(id, cf(opt(layout) 
                              <+ 
                                sort("Productions") 
                              <+
                                sort("Symbols") 
                              <+
                                sort("Priorities")  
                              <+
                                sort("Restrictions")  
                              <+
                                sort("Aliases")  
                               ), id), id ) ; y
             <+
                prod(id,id,id); y
