<?xml version="1.0"?>
<project name="org.strategoxt.StrategoXT" default="all">
	<!-- Import Ant contrib -->
	<taskdef resource="net/sf/antcontrib/antlib.xml" />

	<!-- Import Stratego/XT Ant contributions -->
	<!--<import file="ant-contrib/strategoxt-contrib.xml" />-->

	<!-- Import the properties file, containing e.g. the version number -->
	<property file="build.properties" />

	<!-- Location of the syntax folder -->
	<property name="syntax-dir" value="syntax" />
	<!-- Location of libraries folder -->
	<property name="libraries-dir" value="stratego-libraries" />

	<!-- Destination of files -->
	<property name="lib" location="lib/" />
	<property name="bin" location="bin/" />

	<!-- Import syntax builder -->
	<include file="${syntax-dir}/build.xml" as="syntax" />

	<!-- Import the libraries builder -->
	<include file="${libraries-dir}/build.xml" as="libraries" />

	<target name="all"
	        depends="
		create-dirs,
		syntax,
		generate-java,
		compile-java,
		jar
		" />
	<target name="create-dirs">
		<mkdir dir="${lib}" />
		<mkdir dir="${bin}" />
	</target>

	<target name="clean">
		<delete dir="${lib}" />
		<delete dir="${bin}" />
		<!-- Clean the syntax -->
		<antcall target="syntax.clean">
			<param name="basedir" value="${syntax-dir}" />
		</antcall>
		<antcall target="libraries.clean">
			<param name="basedir" value="${syntax-dir}" />
		</antcall>
	</target>

	<target name="syntax">
		<!-- Build the syntax -->
		<antcall target="syntax.all">
			<param name="basedir" value="${syntax-dir}" />
		</antcall>
	</target>

	<target name="generate-java" depends="syntax">
		<!-- Compile libraries to Java -->
		<antcall target="libraries.part-1">
			<param name="basedir" value="${libraries-dir}" />
		</antcall>
		<antcall target="syntax.java-front-java">
			<param name="basedir" value="${syntax-dir}" />
		</antcall>
		<antcall target="libraries.part-2">
			<param name="basedir" value="${libraries-dir}" />
		</antcall>
	</target>

	<target name="compile-java" depends="generate-java">
		<javac srcdir="${lib}"
		       destdir="${bin}"
		       classpath="${libraries-dir}/java-backend/java/spoofax-libs.jar:${libraries-dir}/java-backend/java/runtime:${bin}"
		       source="1.5"
		       target="1.5"
		       nowarn="on"
		       debug="true"
		       debuglevel="source" />
		<javac srcdir="${libraries-dir}/java-backend/java/runtime"
		       destdir="${bin}"
		       classpath="${libraries-dir}/java-backend/java/spoofax-libs.jar:${libraries-dir}/java-backend/java/runtime:${bin}"
		       source="1.5"
		       target="1.5"
		       nowarn="on"
		       debug="true"
		       debuglevel="source" />
	</target>

	<target name="jar">
		<jar destfile="strategoxt.jar"
		     manifest="${libraries-dir}/java-backend/java/META-INF/MANIFEST.MF">
			<fileset dir="ant-contrib" includes="*.xml" />
			<fileset dir="." includes="COPYING" />
			<fileset dir="${bin}" includes="**/*.class" />
			<fileset dir="${lib}" includes="**/*.rtree" />
			<fileset dir="${lib}" includes="**/*.af" />
			<fileset dir="${lib}" includes="**/*.tbl" />
			<zipfileset includes="**/*"
			            src="${libraries-dir}/java-backend/java/spoofax-libs.jar" />
		</jar>
	</target>
</project>