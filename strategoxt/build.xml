<?xml version="1.0"?>
<project name="org.strategoxt.StrategoXT" default="all">
	<!-- Import Ant contrib -->
	<taskdef resource="net/sf/antcontrib/antcontrib.properties"/>

	<!-- Import Stratego/XT Ant contributions -->
	<import file="ant-contrib/strategoxt-test.xml" />

	<!-- Import the properties file, containing e.g. the version number -->
	<property file="build.properties" />

	<!-- Location of the syntax folder -->
	<property name="syntax-dir" value="syntax" />
	<!-- Location of libraries folder -->
	<property name="libraries-dir" value="stratego-libraries" />

	<!-- Destination of files -->
	<property name="lib" location="lib/" />
	<property name="bin" location="bin/" />
	<property name="test-gen" value="generated/" />
	<!-- For CI builds -->
	<!--<property name="java-front" location="syntax/java-front" />-->
	<property name="install-prefix" location="dist" />
	<property name="install-location" location="${install-prefix}/${install-prefix}/share/strategoxt" />
	<property name="jar.name" value="strategoxt.jar" />

	<!-- Import syntax builder -->
	<include file="${syntax-dir}/build.xml" as="syntax" />

	<!-- Import the libraries builder -->
	<include file="${libraries-dir}/build.xml" as="libraries" />


	<target name="test" depends="create-dirs">
		<for param="deffile">
			<path>
				<fileset dir="${libraries-dir}" includes="sglr/tests/*.def" excludes="sglr/tests/List.def" />
			</path>
			<sequential>
				<basename file="@{deffile}" property="@{deffile}.basename" suffix=".def" />
				<dirname file="@{deffile}" property="@{deffile}.dirname" />
				<property name="@{deffile}.rel" value="@{deffile}" relative="yes" />

				<sdf2rtg input="${@{deffile}.rel}" output="${test-gen}/${@{deffile}.basename}.rtg" main="Main" />
				<rtg2sig input="${test-gen}/${@{deffile}.basename}.rtg"
				         output="${test-gen}/${@{deffile}.basename}.str"
				         main="Main" />
				<sdf2table input="@{deffile}" output="${test-gen}/${@{deffile}.basename}.tbl" main="Main" />
				<copy file="${test-gen}/${@{deffile}.basename}.tbl" tofile="${@{deffile}.dirname}/${@{deffile}.basename}.tbl" />
			</sequential>
		</for>

		<for param="strfile">
			<path>
				<fileset dir="${libraries-dir}" includes="*/tests/*.str" />
				<fileset dir="${syntax-dir}/java-front" includes="test/*.str" />
			</path>
			<sequential>
				<strj-test input="@{strfile}" />
			</sequential>
		</for>
	</target>


	
	
	<macrodef name="strj-test">
			<attribute name="input" />
			<sequential>
				<log message="Testing @{input}" />
				<dirname file="@{input}" property="@{input}.dirname" />
				<basename file="@{input}" property="@{input}.basename" suffix=".str" />
				<mkdir dir="${@{input}.dirname}/${@{input}.basename}/test" />
				<strj-for-test input="@{input}" output="${@{input}.dirname}/${@{input}.basename}/test/Main.java" package="test">
					<strjargs>
						<arg value="-m" />
						<arg value="main-${@{input}.basename}" />
						<arg value="-la" />
						<arg value="stratego-lib" />
						<arg value="-la" />
						<arg value="stratego-gpp" />
						<arg value="-la" />
						<arg value="stratego-xtc" />
						<arg value="-la" />
						<arg value="stratego-aterm" />
						<arg value="-la" />
						<arg value="stratego-rtg" />
						<arg value="-la" />
						<arg value="stratego-sglr" />
						<arg value="-la" />
						<arg value="java-front" />
						<arg value="-I" />
						<arg value="${syntax-dir}/${syn.aterm}" />
						<arg value="-I" />
						<arg value="${syntax-dir}/${syn.box}" />
						<arg value="-I" />
						<arg value="generated/" />
						<arg value="-I" />
						<arg value="${@{input}.dirname}" />
					</strjargs>
					<str-deps>
						<srcfiles dir="." includes="*.jar" />
					</str-deps>
				</strj-for-test>
				<javac srcdir="${@{input}.dirname}/${@{input}.basename}"
				       destdir="${@{input}.dirname}/${@{input}.basename}"
				       classpath="${java.class.path}"
				       source="1.5"
				       target="1.5"
				       nowarn="on"
				       fork="true"
				       debug="true"
				       debuglevel="source"
				       compiler="classic">
				</javac>
				<java fork="true" classname="test.Main" failonerror="true" dir="${@{input}.dirname}">
					<classpath>
						<!--<pathelement location="./strategoxt.jar" />-->
						<pathelement path="${java.class.path}" />
						<pathelement path="${@{input}.dirname}/${@{input}.basename}" />
					</classpath>
				</java>
			</sequential>
		</macrodef>




	<target name="all"
	        depends="
									create-dirs,
									syntax,
									generate-java,
									compile-java,
									jar,
									install" />

	<target name="create-dirs">
		<mkdir dir="${lib}" />
		<mkdir dir="${bin}" />
		<mkdir dir="${test-gen}" />
		<mkdir dir="${install-location}" />
	</target>



	<target name="install" depends="jar">
		<copy file="${jar.name}" tofile="${install-location}/${jar.name}" />
	</target>

	<target name="clean">
		<delete dir="${lib}" />
		<delete dir="${bin}" />
		<delete dir="${test-gen}" />
		<delete dir="${install-prefix}" />
		<delete file="${jar.name}" />
		<!-- Clean the syntax -->
		<antcall target="syntax.clean">
			<param name="basedir" value="${syntax-dir}" />
		</antcall>
		<antcall target="libraries.clean">
			<param name="basedir" value="${syntax-dir}" />
		</antcall>
	</target>

	<target name="syntax">
		<!-- Build the syntax -->
		<antcall target="syntax.all">
			<param name="basedir" value="${syntax-dir}" />
		</antcall>
	</target>

	<target name="generate-java" depends="syntax">
		<!-- Compile libraries to Java -->
		<antcall target="libraries.part-1">
			<param name="basedir" value="${libraries-dir}" />
		</antcall>
		<antcall target="syntax.java-front-java">
			<param name="basedir" value="${syntax-dir}" />
		</antcall>
		<antcall target="libraries.part-2">
			<param name="basedir" value="${libraries-dir}" />
		</antcall>
	</target>

	<target name="compile-java" depends="generate-java">
		<javac srcdir="${lib}"
		       destdir="${bin}"
		       classpath="${libraries-dir}/java-backend/java/spoofax-libs.jar:${libraries-dir}/java-backend/java/runtime:${bin}"
		       source="1.5"
		       target="1.5"
		       nowarn="on"
		       debug="true"
		       debuglevel="source" />
		<javac srcdir="${libraries-dir}/java-backend/java/runtime"
		       destdir="${bin}"
		       classpath="${libraries-dir}/java-backend/java/spoofax-libs.jar:${libraries-dir}/java-backend/java/runtime:${bin}"
		       source="1.5"
		       target="1.5"
		       nowarn="on"
		       debug="true"
		       debuglevel="source" />
	</target>

	<target name="jar">
		<jar destfile="${jar.name}" manifest="${libraries-dir}/java-backend/java/META-INF/MANIFEST.MF">
			<fileset dir="ant-contrib" includes="*.xml" />
			<fileset dir="." includes="COPYING" />
			<fileset dir="${bin}" includes="**/*.class" />
			<fileset dir="${lib}" includes="**/*.rtree" />
			<fileset dir="${lib}" includes="**/*.af" />
			<fileset dir="${lib}" includes="**/*.tbl" />
			<zipfileset includes="**/*" src="${libraries-dir}/java-backend/java/spoofax-libs.jar" />
		</jar>
	</target>
</project>